!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n="undefined"!=typeof globalThis?globalThis:n||self).Sandbox=e()}(this,(function(){"use strict";function n(){}function e(n){return n()}function t(){return Object.create(null)}function o(n){n.forEach(e)}function r(n){return"function"==typeof n}function s(n,e){return n!=n?e==e:n!==e||n&&"object"==typeof n||"function"==typeof n}function a(n,e){n.appendChild(e)}function i(n,e,t){n.insertBefore(e,t||null)}function c(n){n.parentNode.removeChild(n)}function l(n){return document.createElement(n)}function d(n){return document.createTextNode(n)}function u(n,e,t){null==t?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function p(n,e,t){n.classList[t?"add":"remove"](e)}let f;function g(n){f=n}function h(){if(!f)throw new Error("Function called outside component initialization");return f}function _(n){h().$$.on_mount.push(n)}function m(){const n=h();return(e,t)=>{const o=n.$$.callbacks[e];if(o){const r=function(n,e){const t=document.createEvent("CustomEvent");return t.initCustomEvent(n,!1,!1,e),t}(e,t);o.slice().forEach((e=>{e.call(n,r)}))}}}function y(n,e){const t=n.$$.callbacks[e.type];t&&t.slice().forEach((n=>n(e)))}const v=[],w=[],b=[],$=[],x=Promise.resolve();let k=!1;function E(n){b.push(n)}let j=!1;const N=new Set;function M(){if(!j){j=!0;do{for(let n=0;n<v.length;n+=1){const e=v[n];g(e),O(e.$$)}for(g(null),v.length=0;w.length;)w.pop()();for(let n=0;n<b.length;n+=1){const e=b[n];N.has(e)||(N.add(e),e())}b.length=0}while(v.length);for(;$.length;)$.pop()();k=!1,j=!1,N.clear()}}function O(n){if(null!==n.fragment){n.update(),o(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(E)}}const S=new Set;let A;function C(n,e){n&&n.i&&(S.delete(n),n.i(e))}function T(n,e,t,o){if(n&&n.o){if(S.has(n))return;S.add(n),A.c.push((()=>{S.delete(n),o&&(t&&n.d(1),o())})),n.o(e)}}function L(n,t,s){const{fragment:a,on_mount:i,on_destroy:c,after_update:l}=n.$$;a&&a.m(t,s),E((()=>{const t=i.map(e).filter(r);c?c.push(...t):o(t),n.$$.on_mount=[]})),l.forEach(E)}function F(n,e){const t=n.$$;null!==t.fragment&&(o(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function J(n,e){-1===n.$$.dirty[0]&&(v.push(n),k||(k=!0,x.then(M)),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function P(e,r,s,a,i,l,d=[-1]){const u=f;g(e);const p=r.props||{},h=e.$$={fragment:null,ctx:null,props:l,update:n,not_equal:i,bound:t(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:[]),callbacks:t(),dirty:d,skip_bound:!1};let _=!1;if(h.ctx=s?s(e,p,((n,t,...o)=>{const r=o.length?o[0]:t;return h.ctx&&i(h.ctx[n],h.ctx[n]=r)&&(!h.skip_bound&&h.bound[n]&&h.bound[n](r),_&&J(e,n)),t})):[],h.update(),_=!0,o(h.before_update),h.fragment=!!a&&a(h.ctx),r.target){if(r.hydrate){const n=function(n){return Array.from(n.childNodes)}(r.target);h.fragment&&h.fragment.l(n),n.forEach(c)}else h.fragment&&h.fragment.c();r.intro&&C(e.$$.fragment),L(e,r.target,r.anchor),M()}g(u)}class z{$destroy(){F(this,1),this.$destroy=n}$on(n,e){const t=this.$$.callbacks[n]||(this.$$.callbacks[n]=[]);return t.push(e),()=>{const n=t.indexOf(e);-1!==n&&t.splice(n,1)}}$set(n){var e;this.$$set&&(e=n,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(n),this.$$.skip_bound=!1)}}let D=1;function W(n){let e=n.action,t=n.cmd_id,o=this.pending_cmds.get(t);if(o){if(this.pending_cmds.delete(t),"cmd_error"===e){let{message:e,stack:t}=n,r=new Error(e);r.stack=t,o.reject(r)}"cmd_ok"===e&&o.resolve(n.args||"ok")}else console.error("command not found",t,n,[...this.pending_cmds.keys()])}function K(n){if(n.source!==this.iframe.contentWindow)return;const{action:e,args:t}=n.data;switch(e){case"cmd_error":case"cmd_ok":return W.call(this,n.data);case"fetch_progress":return this.handlers.on_fetch_progress(t.remaining);case"error":return this.handlers.on_error(n.data);case"unhandledrejection":return this.handlers.on_unhandled_rejection(n.data);case"console":return this.handlers.on_console(n.data);case"console_group":return this.handlers.on_console_group(n.data);case"console_group_collapsed":return this.handlers.on_console_group_collapsed(n.data);case"console_group_end":return this.handlers.on_console_group_end(n.data);default:const o="on_"+e;"function"==typeof this.handlers[o]&&this.handlers[o](n.data)}}class R{constructor(n,e){this.iframe=n,this.handlers=e,this.pending_cmds=new Map,this.handle_event=K.bind(this),window.addEventListener("message",this.handle_event,!1)}destroy(){window.removeEventListener("message",this.handle_event)}iframe_command(n,e){return new Promise(((t,o)=>{const r=D++;this.pending_cmds.set(r,{resolve:t,reject:o}),this.iframe.contentWindow.postMessage({action:n,cmd_id:r,args:e},"*")}))}size(){return this.iframe_command("size")}eval(n){return this.iframe_command("eval",{script:n})}add_script(n){return this.iframe_command("add_script",n)}add_script_content(n){return this.iframe_command("add_script_content",n)}add_style(n){return this.iframe_command("add_style",n)}add_asset(n){return this.iframe_command("add_asset",n)}handle_links(){return this.iframe_command("catch_clicks",{})}}function U(n){let e;return{c(){e=l("strong"),e.innerHTML="<em>Sorry, an error occured while executing the NFT.</em>",u(e,"class","beyondnft__sandbox__error svelte-uaiew6")},m(n,t){i(n,e,t)},d(n){n&&c(e)}}}function Y(e){let t,o,r,s,f,g=e[3]&&U();return{c(){t=l("div"),o=l("iframe"),f=d(" "),g&&g.c(),u(o,"title","Sandbox"),u(o,"sandbox",r="allow-scripts allow-pointer-lock allow-popups "+e[0]),u(o,"srcdoc",s=e[4]("<!DOCTYPE html>\n<html>\n  <head>\n    <style>\n      \n    </style>\n\n    <script>\n      (function () {\n        const local_eval = eval;\n        eval = function () {};\n\n        function handle_message(ev) {\n          let { action, cmd_id } = ev.data;\n          const send_message = (payload) =>\n            parent.postMessage({ ...payload }, ev.origin);\n\n          const send_reply = (payload) => send_message({ ...payload, cmd_id });\n          const send_ok = (args) => send_reply({ action: 'cmd_ok', args });\n          const send_error = (message, stack) =>\n            send_reply({ action: 'cmd_error', message, stack });\n\n          if (action === 'size') {\n            send_ok({\n              width: document.body.offsetWidth,\n              height: document.body.offsetHeight,\n            });\n          }\n\n          if (action === 'eval') {\n            try {\n              const { script } = ev.data.args;\n              local_eval(script);\n              send_ok();\n            } catch (e) {\n              send_error(e.message, e.stack);\n            }\n          }\n\n          if (action === 'add_script') {\n            try {\n              const script = document.createElement('script');\n              script.src = ev.data.args;\n              script.onload = () => send_ok();\n              document.body.appendChild(script);\n            } catch (e) {\n              send_error(e.message, e.stack);\n            }\n          }\n\n          if (action === 'add_script_content') {\n            try {\n              const script = document.createElement('script');\n              script.text = ev.data.args;\n              script.type = 'text/javascript';\n              document.body.appendChild(script);\n              send_ok();\n            } catch (e) {\n              send_error(e.message, e.stack);\n            }\n          }\n\n          if (action === 'add_style') {\n            try {\n              const link = document.createElement('link');\n              link.rel = 'stylesheet';\n              link.href = ev.data.args;\n              link.onload = () => send_ok();\n              document.body.appendChild(link);\n            } catch (e) {\n              send_error(e.message, e.stack);\n            }\n          }\n\n          if (action === 'catch_clicks') {\n            try {\n              const top_origin = ev.origin;\n              document.body.addEventListener('click', (event) => {\n                if (event.which !== 1) return;\n                if (event.metaKey || event.ctrlKey || event.shiftKey) return;\n                if (event.defaultPrevented) return;\n\n                // ensure target is a link\n                let el = event.target;\n                while (el && el.nodeName !== 'A') el = el.parentNode;\n                if (!el || el.nodeName !== 'A') return;\n\n                if (\n                  el.hasAttribute('download') ||\n                  el.getAttribute('rel') === 'external' ||\n                  el.target\n                )\n                  return;\n\n                event.preventDefault();\n\n                if (el.href.startsWith(top_origin)) {\n                  const url = new URL(el.href);\n                  if (url.hash[0] === '#') {\n                    window.location.hash = url.hash;\n                    return;\n                  }\n                }\n\n                window.open(el.href, '_blank');\n              });\n              send_ok();\n            } catch (e) {\n              send_error(e.message, e.stack);\n            }\n          }\n        }\n\n        window.addEventListener('message', handle_message, false);\n\n        window.onerror = function (msg, url, lineNo, columnNo, error) {\n          try {\n            parent.postMessage({ action: 'error', value: error }, '*');\n          } catch (e) {\n            parent.postMessage({ action: 'error', value: msg }, '*');\n            parent.postMessage({ action: 'error', value: error }, '*');\n          }\n        };\n\n        window.addEventListener('unhandledrejection', (event) => {\n          parent.postMessage(\n            { action: 'unhandledrejection', value: event.reason },\n            '*'\n          );\n        });\n\n        let previous = { level: null, args: null };\n\n        ['clear', 'log', 'info', 'dir', 'warn', 'error', 'table'].forEach(\n          (level) => {\n            const original = console[level];\n            console[level] = (...args) => {\n              const stringifiedArgs = stringify(args);\n              if (\n                previous.level === level &&\n                previous.args &&\n                previous.args === stringifiedArgs\n              ) {\n                parent.postMessage(\n                  { action: 'console', level, duplicate: true },\n                  '*'\n                );\n              } else {\n                previous = { level, args: stringifiedArgs };\n\n                try {\n                  parent.postMessage({ action: 'console', level, args }, '*');\n                } catch (err) {\n                  parent.postMessage(\n                    { action: 'console', level: 'unclonable' },\n                    '*'\n                  );\n                }\n              }\n\n              original(...args);\n            };\n          }\n        );\n\n        [\n          { method: 'group', action: 'console_group' },\n          { method: 'groupEnd', action: 'console_group_end' },\n          { method: 'groupCollapsed', action: 'console_group_collapsed' },\n        ].forEach((group_action) => {\n          const original = console[group_action.method];\n          console[group_action.method] = (label) => {\n            parent.postMessage({ action: group_action.action, label }, '*');\n\n            original(label);\n          };\n        });\n\n        const timers = new Map();\n        const original_time = console.time;\n        const original_timelog = console.timeLog;\n        const original_timeend = console.timeEnd;\n\n        console.time = (label = 'default') => {\n          original_time(label);\n          timers.set(label, performance.now());\n        };\n        console.timeLog = (label = 'default') => {\n          original_timelog(label);\n          const now = performance.now();\n          if (timers.has(label)) {\n            parent.postMessage(\n              {\n                action: 'console',\n                level: 'system-log',\n                args: [`${label}: ${now - timers.get(label)}ms`],\n              },\n              '*'\n            );\n          } else {\n            parent.postMessage(\n              {\n                action: 'console',\n                level: 'system-warn',\n                args: [`Timer '${label}' does not exist`],\n              },\n              '*'\n            );\n          }\n        };\n        console.timeEnd = (label = 'default') => {\n          original_timeend(label);\n          const now = performance.now();\n          if (timers.has(label)) {\n            parent.postMessage(\n              {\n                action: 'console',\n                level: 'system-log',\n                args: [`${label}: ${now - timers.get(label)}ms`],\n              },\n              '*'\n            );\n          } else {\n            parent.postMessage(\n              {\n                action: 'console',\n                level: 'system-warn',\n                args: [`Timer '${label}' does not exist`],\n              },\n              '*'\n            );\n          }\n          timers.delete(label);\n        };\n\n        const original_assert = console.assert;\n        console.assert = (condition, ...args) => {\n          if (condition) {\n            const stack = new Error().stack;\n            parent.postMessage(\n              { action: 'console', level: 'assert', args, stack },\n              '*'\n            );\n          }\n          original_assert(condition, ...args);\n        };\n\n        const counter = new Map();\n        const original_count = console.count;\n        const original_countreset = console.countReset;\n\n        console.count = (label = 'default') => {\n          counter.set(label, (counter.get(label) || 0) + 1);\n          parent.postMessage(\n            {\n              action: 'console',\n              level: 'system-log',\n              args: `${label}: ${counter.get(label)}`,\n            },\n            '*'\n          );\n          original_count(label);\n        };\n\n        console.countReset = (label = 'default') => {\n          if (counter.has(label)) {\n            counter.set(label, 0);\n          } else {\n            parent.postMessage(\n              {\n                action: 'console',\n                level: 'system-warn',\n                args: `Count for '${label}' does not exist`,\n              },\n              '*'\n            );\n          }\n          original_countreset(label);\n        };\n\n        const original_trace = console.trace;\n\n        console.trace = (...args) => {\n          const stack = new Error().stack;\n          parent.postMessage(\n            { action: 'console', level: 'trace', args, stack },\n            '*'\n          );\n          original_trace(...args);\n        };\n\n        function stringify(args) {\n          try {\n            return JSON.stringify(args);\n          } catch (error) {\n            return null;\n          }\n        }\n      })(this);\n\n      // remove alert, set window context\n      (() => {\n        const original_alert = window.alert;\n        window.alert = function () {};\n\n        window.context = {\n          nft_json: {},\n          config: {},\n          owner: '0x0000000000000000000000000000000000000000',\n        };\n      })(this);\n    <\/script>\n    <style>\n      body,\n      html {\n        padding: 0;\n        margin: 0;\n        min-width: 100%;\n        min-height: 100%;\n      }\n\n      body {\n        position: absolute;\n        top: 0;\n        left: 0;\n      }\n    </style>\n  </head>\n  <body>\n    \x3c!-- NFTCODE --\x3e\n  </body>\n</html>\n")),u(o,"class","svelte-uaiew6"),p(o,"greyed-out",e[3]||B||e[2]),u(t,"class","beyondnft__sandbox svelte-uaiew6")},m(n,r){i(n,t,r),a(t,o),e[10](o),a(t,f),g&&g.m(t,null)},p(n,[e]){1&e&&r!==(r="allow-scripts allow-pointer-lock allow-popups "+n[0])&&u(o,"sandbox",r),12&e&&p(o,"greyed-out",n[3]||B||n[2]),n[3]?g||(g=U(),g.c(),g.m(t,null)):g&&(g.d(1),g=null)},i:n,o:n,d(n){n&&c(t),e[10](null),g&&g.d()}}}let B=!1;function H(n,e,t){let{code:o=""}=e,{proxy:r}=e,{json:s}=e,{owner_properties:a}=e,{owner:i}=e,{sandbox_props:c=""}=e;const l=m();let d,u,p,f=0,g=[],h=[],y=g;function v(){return s.interactive_nft?function(n){let e="";if(Array.isArray(n))for(const t of n){const n=t.type;"script"===n?e+=`<script type="text/javascript" src="${t.url}"><\/script>`:"style"===n?e+=`<script type="text/javascript">\n\t\t\t\t\t\t(() => {\n\t\t\t\t\t\t\tconst link = document.createElement('link');\n\t\t\t\t\t\t\tlink.rel = 'stylesheet';\n\t\t\t\t\t\t\tlink.href = "${t.url}";\n\t\t\t\t\t\t\tdocument.body.appendChild(link);\n\t\t\t\t\t\t})()\n\t\t\t\t\t<\/script>`:console.log("Unknown dependency type "+n)}return e}(s.interactive_nft.dependencies):""}function b(n){t(3,u=n),l("error",n)}function $(n){y.push(p=n),g=g}function x(n,e){const t={level:"group",label:n,collapsed:e,logs:[]};y.push(t),h.push(y),y=t.logs,g=g}return _((()=>(t(5,r=new R(d,{on_fetch_progress:n=>{t(2,f=n)},on_error:n=>{$({level:"error",args:[n.value]}),b(n.value)},on_unhandled_rejection:n=>{let e=n.value;"string"==typeof e&&(e={message:e}),e.message="Uncaught (in promise): "+e.message,$({level:"error",args:[e]}),b(e)},on_console:n=>{"clear"===n.level?(y=g=[],$(n)):n.duplicate?function(){const n=y[y.length-1];n?(n.count=(n.count||1)+1,g=g):(p.count=1,$(p))}():$(n)},on_console_group:n=>{x(n.label,!1)},on_console_group_end:()=>{y=h.pop()},on_console_group_collapsed:n=>{x(n.label,!0)}})),d.addEventListener("load",(()=>{r.handle_links(),!u&&l("loaded")})),()=>{r.destroy()}))),n.$$set=n=>{"code"in n&&t(6,o=n.code),"proxy"in n&&t(5,r=n.proxy),"json"in n&&t(7,s=n.json),"owner_properties"in n&&t(8,a=n.owner_properties),"owner"in n&&t(9,i=n.owner),"sandbox_props"in n&&t(0,c=n.sandbox_props)},[c,d,f,u,function(n){let e=v();const t=function(){const n={};if(s.interactive_nft&&Array.isArray(s.interactive_nft.properties)){let e={};a&&"object"==typeof a&&(e=a);for(const t of s.interactive_nft.properties)n[t.name]=t.value,void 0!==e[t.name]&&(n[t.name]=e[t.name])}return n}(),r=`\n      window.context.properties = JSON.parse('${JSON.stringify(t)}');\n    `,c=`\n      window.context.nft_json = JSON.parse(${JSON.stringify(JSON.stringify(s))});\n    `,l=`window.context.owner = ${JSON.stringify(i)};`;return e+=`<script type="text/javascript">${`\n      // specific p5 because it's causing troubles.\n      if (typeof p5 !== 'undefined' && p5.disableFriendlyErrors) {\n        p5.disableFriendlyErrors = true;\n        new p5();\n      }\n\n      ${r}\n      ${c}\n      ${l}\n    `}<\/script>`,e+=o,n.replace("\x3c!-- NFTCODE --\x3e",e)},r,o,s,a,i,function(n){w[n?"unshift":"push"]((()=>{d=n,t(1,d)}))}]}class q extends z{constructor(n){var e;super(),document.getElementById("svelte-uaiew6-style")||((e=l("style")).id="svelte-uaiew6-style",e.textContent=".beyondnft__sandbox.svelte-uaiew6{background-color:white;border:none;width:100%;height:100%;position:relative}iframe.svelte-uaiew6{min-width:100%;min-height:100%;border:none;display:block}.greyed-out.svelte-uaiew6{filter:grayscale(50%) blur(1px);opacity:0.25}.beyondnft__sandbox__error.svelte-uaiew6{font-size:0.9em;position:absolute;top:0;left:0;padding:5px}",a(document.head,e)),P(this,n,H,Y,s,{code:6,proxy:5,json:7,owner_properties:8,owner:9,sandbox_props:0})}}function I(e){let t;return{c(){t=d("Loading...")},m(n,e){i(n,t,e)},p:n,i:n,o:n,d(n){n&&c(t)}}}function G(n){let e,t,o;function r(e){n[8].call(null,e)}let s={code:n[1],owner_properties:n[2],sandbox_props:n[4],owner:n[3],json:n[0]};return void 0!==n[5]&&(s.proxy=n[5]),e=new q({props:s}),w.push((()=>function(n,e,t){const o=n.$$.props[e];void 0!==o&&(n.$$.bound[o]=t,t(n.$$.ctx[o]))}(e,"proxy",r))),e.$on("loaded",n[9]),e.$on("error",n[10]),e.$on("warning",n[11]),{c(){var n;(n=e.$$.fragment)&&n.c()},m(n,t){L(e,n,t),o=!0},p(n,o){const r={};var s;2&o&&(r.code=n[1]),4&o&&(r.owner_properties=n[2]),16&o&&(r.sandbox_props=n[4]),8&o&&(r.owner=n[3]),1&o&&(r.json=n[0]),!t&&32&o&&(t=!0,r.proxy=n[5],s=()=>t=!1,$.push(s)),e.$set(r)},i(n){o||(C(e.$$.fragment,n),o=!0)},o(n){T(e.$$.fragment,n),o=!1},d(n){F(e,n)}}}function Q(n){let e,t,r,s;const a=[G,I],l=[];function u(n,e){return n[1]?0:1}return e=u(n),t=l[e]=a[e](n),{c(){t.c(),r=d("")},m(n,t){l[e].m(n,t),i(n,r,t),s=!0},p(n,[s]){let i=e;e=u(n),e===i?l[e].p(n,s):(A={r:0,c:[],p:A},T(l[i],1,1,(()=>{l[i]=null})),A.r||o(A.c),A=A.p,t=l[e],t||(t=l[e]=a[e](n),t.c()),C(t,1),t.m(r.parentNode,r))},i(n){s||(C(t),s=!0)},o(n){T(t),s=!1},d(n){l[e].d(n),n&&c(r)}}}function V(n,e,t){const o=m();let{data:r={}}=e,{code:s=""}=e,{owner_properties:a={}}=e,{owner:i="0x0000000000000000000000000000000000000000"}=e,{sandbox_props:c=""}=e;let l=null;return _((async()=>{"string"==typeof r&&await fetch(r).then((n=>n.json())).then((n=>t(0,r=n))).catch((n=>{o("warning",new Error("Error while fetching NFT's JSON at "+r)),t(0,r=null)})),r?(a&&"string"==typeof a&&await fetch(a).then((n=>n.json())).then((n=>t(2,a=n))).catch((n=>{o("warning",`Error while fetching owner_properties on ${a}.\n            Setting owner_properties to default.`),t(2,a={})})),!s&&r.interactive_nft&&(r.interactive_nft.code?(t(1,s=r.interactive_nft.code),t(0,r.interactive_nft.code=null,r)):r.interactive_nft.code_uri&&await fetch(r.interactive_nft.code_uri).then((n=>n.text())).then((n=>t(1,s=n))).catch((n=>{o("Error",new Error("Error while fetching "+r.interactive_nft.code_uri))}))),s||o("Error",new Error("You need to provide code for this NFT to run"))):o("error",new Error("You need to provide a data property.\n      Either a valid uri to the NFT JSON or the parsed NFT JSON."))})),n.$$set=n=>{"data"in n&&t(0,r=n.data),"code"in n&&t(1,s=n.code),"owner_properties"in n&&t(2,a=n.owner_properties),"owner"in n&&t(3,i=n.owner),"sandbox_props"in n&&t(4,c=n.sandbox_props)},[r,s,a,i,c,l,"0.0.5",function(){return l},function(n){l=n,t(5,l)},function(e){y(n,e)},function(e){y(n,e)},function(e){y(n,e)}]}return class extends z{constructor(n){super(),P(this,n,V,Q,s,{data:0,code:1,owner_properties:2,owner:3,sandbox_props:4,version:6,getProxy:7})}get version(){return this.$$.ctx[6]}get getProxy(){return this.$$.ctx[7]}}}));
